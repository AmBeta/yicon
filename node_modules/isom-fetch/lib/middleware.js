'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _process = require('process');

var _process2 = _interopRequireDefault(_process);

var _defaults = require('./defaults');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var privateType = '@@isom-fetch/data-rendered-by-server-side';

var isomFetchMiddleware = function isomFetchMiddleware(_ref) {
  var dispatch = _ref.dispatch;
  return function (next) {
    return function (action) {
      if (_process2.default.browser) {
        var payload = action.payload;

        if (typeof payload === 'function' && payload.isomFetch === true) {
          var fetched = window[(0, _defaults.getUrlState)()];
          if (fetched && fetched[payload.url] > 0) {
            // 如果已经被渲染，就无需执行这次 dispatch，直接返回未被 reducer 处理的 state
            fetched[payload.url]--;
            action.type = privateType;
            return next(action);
          }
          return payload(dispatch, action);
        }
      }
      return next(action);
    };
  };
};

exports.default = isomFetchMiddleware;